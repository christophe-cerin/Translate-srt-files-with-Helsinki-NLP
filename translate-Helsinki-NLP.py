#
# https://huggingface.co/Helsinki-NLP
# The list of models is located at:
# https://github.com/Helsinki-NLP/Opus-MT-train/tree/master/models
#
#
# Check with:
# https://www.scaleway.com/en/blog/ai-in-practice-generating-video-subtitles/
#
# Need transformers:
# python3 -m pip install transformers SentencePiece
#
# Need pytorch too:
# python3 -m pip install torch
#
# Need extra stuff:
# python3 -m pip install sacremoses
#

models = [
    'aed-es',
    'af-de',
    'af-en',
    'af-es',
    'af-fi',
    'af-fr',
    'af-sv',
    'am-en',
    'am-sv',
    'ar-de',
    'ar-en',
    'ar-fi',
    'ar-fr',
    'as-en',
    'ase-de',
    'ase-en',
    'ase-es',
    'ase-fr',
    'ase-sv',
    'az-en',
    'bcl-de',
    'bcl-en',
    'bcl-es',
    'bcl-fi',
    'bcl-fr',
    'bcl-sv',
    'bem-en',
    'bem-es',
    'bem-fi',
    'bem-fr',
    'bem-sv',
    'ber-en',
    'ber-es',
    'ber-fr',
    'bg-en',
    'bg-es',
    'bg-fi',
    'bg-fr',
    'bg-sv',
    'bi-en',
    'bi-es',
    'bi-fr',
    'bi-sv',
    'bn-en',
    'br-en',
    'bs-en',
    'bzs-en',
    'bzs-es',
    'bzs-fi',
    'bzs-fr',
    'bzs-sv',
    'ca-de',
    'ca-en',
    'ca-es',
    'ca-fr',
    'ceb-en',
    'ceb-es',
    'ceb-fi',
    'ceb-fr',
    'ceb-sv',
    'chk-en',
    'chk-es',
    'chk-fr',
    'chk-sv',
    'crs-de',
    'crs-en',
    'crs-es',
    'crs-fi',
    'crs-fr',
    'crs-sv',
    'cs-de',
    'cs-en',
    'cs-fi',
    'cs-fr',
    'cs-sv',
    'csg-es',
    'csn-es',
    'cy-en',
    'da-de',
    'da-en',
    'da-es',
    'da-fi',
    'da-fr',
    'de-af',
    'de-ase',
    'de-bcl',
    'de-bi',
    'de-bzs',
    'de-ca',
    'de-crs',
    'de-cs',
    'de-da',
    'de-de',
    'de-ee',
    'de-efi',
    'de-el',
    'de-en',
    'de-eo',
    'de-es',
    'de-et',
    'de-fi',
    'de-fj',
    'de-fr',
    'de-gaa',
    'de-gil',
    'de-guw',
    'de-ha',
    'de-he',
    'de-hil',
    'de-ho',
    'de-hr',
    'de-ht',
    'de-hu',
    'de-ig',
    'de-ilo',
    'de-is',
    'de-iso',
    'de-it',
    'de-kg',
    'de-ln',
    'de-loz',
    'de-lt',
    'de-lua',
    'de-mt',
    'de-niu',
    'de-nl',
    'de-nso',
    'de-ny',
    'de-pag',
    'de-pap',
    'de-pis',
    'de-pl',
    'de-pon',
    'de-sk',
    'de-sv',
    'ee-de',
    'ee-en',
    'ee-es',
    'ee-fi',
    'ee-fr',
    'ee-sv',
    'efi-de',
    'efi-en',
    'efi-fi',
    'efi-fr',
    'efi-sv',
    'el-en',
    'el-fi',
    'el-fr',
    'el-sv',
    'en-af',
    'en-am',
    'en-as',
    'en-ase',
    'en-bcl',
    'en-bem',
    'en-ber',
    'en-bg',
    'en-bi',
    'en-bn',
    'en-br',
    'en-bs',
    'en-bzs',
    'en-ca',
    'en-ceb',
    'en-chk',
    'en-chr',
    'en-cjp',
    'en-cop',
    'en-crs',
    'en-cs',
    'en-cy',
    'en-da',
    'en-de',
    'en-dop',
    'en-ee',
    'en-efi',
    'en-el',
    'en-eo',
    'en-es',
    'en-et',
    'en-eu',
    'en-fi',
    'en-fj',
    'en-fr',
    'en-ga',
    'en-gaa',
    'en-gil',
    'en-gl',
    'en-guw',
    'en-gv',
    'en-ha',
    'en-he',
    'en-hil',
    'en-ho',
    'en-hr',
    'en-ht',
    'en-hu',
    'en-id',
    'en-ig',
    'en-ilo',
    'en-is',
    'en-iso',
    'en-it',
    'en-jap',
    'en-kg',
    'en-kj',
    'en-km',
    'en-kqn',
    'en-kwn',
    'en-kwy',
    'en-lg',
    'en-ln',
    'en-loz',
    'en-lt',
    'en-lu',
    'en-lua',
    'en-lue',
    'en-lun',
    'en-luo',
    'en-lus',
    'en-mfe',
    'en-mg',
    'en-mh',
    'en-mk',
    'en-ml',
    'en-ml',
    'en-mos',
    'en-mr',
    'en-ms',
    'en-mt',
    'en-nb',
    'en-ne',
    'en-ng',
    'en-niu',
    'en-nl',
    'en-no',
    'en-nso',
    'en-ny',
    'en-nyk',
    'en-om',
    'en-pag',
    'en-pap',
    'en-pis',
    'en-pl',
    'en-pon',
    'en-pt',
    'en-quw',
    'en-rnd',
    'en-ro',
    'en-ru',
    'en-run',
    'en-rw',
    'en-sg',
    'en-sk',
    'en-sl',
    'en-sm',
    'en-sn',
    'en-so',
    'en-sq',
    'en-sr',
    'en-srn',
    'en-ss',
    'en-st',
    'en-sv',
    'en-sw',
    'en-swc',
    'en-syr',
    'en-ta',
    'en-tdt',
    'en-ti',
    'en-tiv',
    'en-tl',
    'en-tll',
    'en-tn',
    'en-to',
    'en-toi',
    'en-tpi',
    'en-ts',
    'en-tt',
    'en-tvl',
    'en-tw',
    'en-ty',
    'en-uk',
    'en-umb',
    'en-ve',
    'en-wa',
    'en-wal',
    'en-wls',
    'en-wo',
    'en-xh',
    'en-yap',
    'en-yo',
    'en-zne',
    'eo-de',
    'eo-en',
    'eo-es',
    'eo-fr',
    'eo-sv',
    'es-aed',
    'es-af',
    'es-ase',
    'es-bcl',
    'es-ber',
    'es-bg',
    'es-bi',
    'es-bzs',
    'es-ca',
    'es-ceb',
    'es-crs',
    'es-cs',
    'es-csg',
    'es-csn',
    'es-da',
    'es-de',
    'es-ee',
    'es-efi',
    'es-el',
    'es-en',
    'es-eo',
    'es-es',
    'es-et',
    'es-eu',
    'es-fi',
    'es-fj',
    'es-fr',
    'es-gaa',
    'es-gil',
    'es-gl',
    'es-guw',
    'es-ha',
    'es-he',
    'es-hil',
    'es-ho',
    'es-hr',
    'es-ht',
    'es-id',
    'es-ig',
    'es-ilo',
    'es-is',
    'es-iso',
    'es-it',
    'es-kg',
    'es-ln',
    'es-loz',
    'es-lua',
    'es-lus',
    'es-mfs',
    'es-mk',
    'es-mt',
    'es-niu',
    'es-nl',
    'es-nso',
    'es-ny',
    'es-pag',
    'es-pap',
    'es-pis',
    'es-pl',
    'es-pon',
    'es-prl',
    'es-ro',
    'es-ru',
    'es-rw',
    'es-sg',
    'es-sl',
    'es-sm',
    'es-sn',
    'es-srn',
    'es-st',
    'es-swc',
    'es-tll',
    'es-tn',
    'es-to',
    'es-tpi',
    'es-tvl',
    'es-tw',
    'es-ty',
    'es-tzo',
    'es-uk',
    'es-ve',
    'es-war',
    'es-wls',
    'es-xh',
    'es-yo',
    'es-yua',
    'es-zai',
    'et+fi-en',
    'et+fi-fr',
    'et-de',
    'et-en',
    'et-es',
    'et-fi',
    'et-fr',
    'et-sv',
    'eu-en',
    'eu-es',
    'fa-fi',
    'fi+sv-en',
    'fi-af',
    'fi-ar',
    'fi-bcl',
    'fi-bem',
    'fi-bg',
    'fi-bzs',
    'fi-ceb',
    'fi-crs',
    'fi-cs',
    'fi-de',
    'fi-ee',
    'fi-efi',
    'fi-el',
    'fi-en',
    'fi-es',
    'fi-et',
    'fi-fa',
    'fi-fi',
    'fi-fj',
    'fi-fr',
    'fi-fse',
    'fi-gaa',
    'fi-gil',
    'fi-guw',
    'fi-ha',
    'fi-he',
    'fi-hil',
    'fi-ho',
    'fi-hr',
    'fi-ht',
    'fi-hu',
    'fi-id',
    'fi-ig',
    'fi-ilo',
    'fi-is',
    'fi-iso',
    'fi-it',
    'fi-kg',
    'fi-kqn',
    'fi-lg',
    'fi-ln',
    'fi-lu',
    'fi-lua',
    'fi-lue',
    'fi-lus',
    'fi-lv',
    'fi-mfe',
    'fi-mg',
    'fi-mh',
    'fi-mk',
    'fi-mos',
    'fi-mt',
    'fi-niu',
    'fi-nl',
    'fi-nso',
    'fi-ny',
    'fi-pag',
    'fi-pap',
    'fi-pis',
    'fi-pl',
    'fi-pon',
    'fi-ro',
    'fi-ru',
    'fi-run',
    'fi-rw',
    'fi-sg',
    'fi-sk',
    'fi-sl',
    'fi-sm',
    'fi-sn',
    'fi-sq',
    'fi-srn',
    'fi-st',
    'fi-sv',
    'fi-sw',
    'fi-swc',
    'fi-tiv',
    'fi-tll',
    'fi-tn',
    'fi-to',
    'fi-toi',
    'fi-tpi',
    'fi-tr',
    'fi-ts',
    'fi-tvl',
    'fi-tw',
    'fi-ty',
    'fi-uk',
    'fi-ve',
    'fi-vi',
    'fi-war',
    'fi-wls',
    'fi-xh',
    'fi-yap',
    'fi-yo',
    'fi-zne',
    'fj-en',
    'fj-fr',
    'fr-af',
    'fr-ase',
    'fr-bcl',
    'fr-bem',
    'fr-ber',
    'fr-bi',
    'fr-bzs',
    'fr-ca',
    'fr-ceb',
    'fr-crs',
    'fr-de',
    'fr-ee',
    'fr-efi',
    'fr-el',
    'fr-en',
    'fr-eo',
    'fr-es',
    'fr-et+fi',
    'fr-fi',
    'fr-fj',
    'fr-gaa',
    'fr-gil',
    'fr-guw',
    'fr-ha',
    'fr-he',
    'fr-hil',
    'fr-ho',
    'fr-hr',
    'fr-ht',
    'fr-hu',
    'fr-id',
    'fr-ig',
    'fr-ilo',
    'fr-iso',
    'fr-kg',
    'fr-kqn',
    'fr-kwy',
    'fr-lg',
    'fr-ln',
    'fr-loz',
    'fr-lu',
    'fr-lua',
    'fr-lue',
    'fr-lus',
    'fr-mfe',
    'fr-mh',
    'fr-mos',
    'fr-mt',
    'fr-niu',
    'fr-nl',
    'fr-nso',
    'fr-ny',
    'fr-pag',
    'fr-pap',
    'fr-pis',
    'fr-pl',
    'fr-pon',
    'fr-rnd',
    'fr-ro',
    'fr-ru',
    'fr-run',
    'fr-rw',
    'fr-sg',
    'fr-sk',
    'fr-sl',
    'fr-sm',
    'fr-sn',
    'fr-srn',
    'fr-st',
    'fr-sv',
    'fr-swc',
    'fr-tiv',
    'fr-tll',
    'fr-tn',
    'fr-to',
    'fr-tpi',
    'fr-ts',
    'fr-tum',
    'fr-tvl',
    'fr-tw',
    'fr-ty',
    'fr-uk',
    'fr-ve',
    'fr-war',
    'fr-wls',
    'fr-xh',
    'fr-yap',
    'fr-yo',
    'fr-zne',
    'fse-fi',
    'ga-en',
    'gaa-de',
    'gaa-en',
    'gaa-es',
    'gaa-fi',
    'gaa-fr',
    'gaa-sv',
    'gil-en',
    'gil-es',
    'gil-fi',
    'gil-fr',
    'gil-sv',
    'gl-en',
    'gl-es',
    'guw-de',
    'guw-en',
    'guw-es',
    'guw-fi',
    'guw-fr',
    'guw-sv',
    'gv-en',
    'ha-en',
    'ha-es',
    'ha-fi',
    'ha-fr',
    'ha-sv',
    'he-de',
    'he-en',
    'he-fi',
    'he-sv',
    'hi-en',
    'hil-de',
    'hil-en',
    'hil-fi',
    'ho-en',
    'hr-en',
    'hr-es',
    'hr-fi',
    'hr-fr',
    'hr-sv',
    'ht-en',
    'ht-es',
    'ht-fi',
    'ht-fr',
    'ht-sv',
    'hu-de',
    'hu-en',
    'hu-fi',
    'hu-fr',
    'hu-sv',
    'hy-en',
    'id-en',
    'id-es',
    'id-fi',
    'id-fr',
    'id-sv',
    'ig-de',
    'ig-en',
    'ig-es',
    'ig-fi',
    'ig-fr',
    'ig-sv',
    'ilo-de',
    'ilo-en',
    'ilo-es',
    'ilo-fi',
    'ilo-sv',
    'is-de',
    'is-en',
    'is-es',
    'is-fi',
    'is-fr',
    'is-sv',
    'iso-en',
    'iso-es',
    'iso-fi',
    'iso-fr',
    'iso-sv',
    'it-de',
    'it-en',
    'it-es',
    'it-fr',
    'it-sv',
    'ja-de',
    'ja-en',
    'ja-es',
    'ja-fi',
    'ja-fr',
    'ja-sv',
    'jap-en',
    'ka-en',
    'kab-en',
    'kg-en',
    'kg-es',
    'kg-fr',
    'kg-sv',
    'kj-en',
    'kl-en',
    'ko-de',
    'ko-en',
    'ko-es',
    'ko-fi',
    'ko-sv',
    'kqn-en',
    'kqn-es',
    'kqn-fr',
    'kqn-sv',
    'kwn-en',
    'kwy-en',
    'kwy-fr',
    'kwy-sv',
    'lg-en',
    'lg-es',
    'lg-fi',
    'lg-fr',
    'lg-sv',
    'ln-de',
    'ln-en',
    'ln-es',
    'ln-fr',
    'loz-de',
    'loz-en',
    'loz-es',
    'loz-fi',
    'loz-fr',
    'loz-sv',
    'lt-de',
    'lt-en',
    'lt-es',
    'lt-fr',
    'lt-sv',
    'lu-en',
    'lu-es',
    'lu-fi',
    'lu-fr',
    'lu-sv',
    'lua-en',
    'lua-es',
    'lua-fi',
    'lua-fr',
    'lua-sv',
    'lue-en',
    'lue-es',
    'lue-fi',
    'lue-fr',
    'lue-sv',
    'lun-en',
    'luo-en',
    'lus-en',
    'lus-es',
    'lus-fi',
    'lus-fr',
    'lus-sv',
    'lv-en',
    'lv-es',
    'lv-fi',
    'lv-fr',
    'lv-sv',
    'mfe-en',
    'mfe-es',
    'mfs-es',
    'mg-en',
    'mg-es',
    'mh-en',
    'mh-es',
    'mh-fi',
    'mk-en',
    'mk-es',
    'mk-fi',
    'mk-fr',
    'ml-en',
    'mos-en',
    'mr-en',
    'ms-en',
    'mt-en',
    'mt-es',
    'mt-fi',
    'mt-fr',
    'mt-sv',
    'nb-en',
    'ne-en',
    'ng-en',
    'niu-de',
    'niu-en',
    'niu-es',
    'niu-fi',
    'niu-fr',
    'niu-sv',
    'nl-de',
    'nl-en',
    'nl-es',
    'nl-fi',
    'nl-fr',
    'nl-sv',
    'nn-en',
    'nso-de',
    'nso-en',
    'nso-es',
    'nso-fi',
    'nso-fr',
    'nso-sv',
    'ny-de',
    'ny-en',
    'ny-es',
    'nyk-en',
    'om-en',
    'pa-en',
    'pag-de',
    'pag-en',
    'pag-es',
    'pag-fi',
    'pag-sv',
    'pap-de',
    'pap-en',
    'pap-es',
    'pap-fi',
    'pap-fr',
    'pis-en',
    'pis-es',
    'pis-fi',
    'pis-fr',
    'pis-sv',
    'pl-de',
    'pl-en',
    'pl-es',
    'pl-fi',
    'pl-fr',
    'pl-sv',
    'pon-en',
    'pon-es',
    'pon-fi',
    'pon-fr',
    'pon-sv',
    'prl-es',
    'pt-en',
    'rnd-en',
    'rnd-fr',
    'rnd-sv',
    'ro-en',
    'ro-fi',
    'ro-fr',
    'ro-sv',
    'ru-en',
    'ru-es',
    'ru-fi',
    'ru-fr',
    'run-en',
    'run-es',
    'run-sv',
    'rw-en',
    'rw-es',
    'rw-fr',
    'rw-sv',
    'sg-en',
    'sg-es',
    'sg-fi',
    'sg-fr',
    'sg-sv',
    'si-en',
    'sk-en',
    'sk-es',
    'sk-fi',
    'sk-fr',
    'sk-sv',
    'sl-es',
    'sl-fi',
    'sl-fr',
    'sl-sv',
    'sm-en',
    'sm-es',
    'sm-fr',
    'sn-en',
    'sn-es',
    'sn-fr',
    'sn-sv',
    'so-en',
    'sq-en',
    'sq-es',
    'sq-fi',
    'sq-sv',
    'sr-en',
    'srn-en',
    'srn-es',
    'srn-fr',
    'srn-sv',
    'ss-en',
    'ssp-es',
    'st-en',
    'st-es',
    'st-fi',
    'st-fr',
    'st-sv',
    'sv-af',
    'sv-ase',
    'sv-bcl',
    'sv-bem',
    'sv-bg',
    'sv-bi',
    'sv-bzs',
    'sv-ceb',
    'sv-chk',
    'sv-crs',
    'sv-cs',
    'sv-de',
    'sv-ee',
    'sv-efi',
    'sv-el',
    'sv-en',
    'sv-eo',
    'sv-es',
    'sv-et',
    'sv-fi',
    'sv-fj',
    'sv-fr',
    'sv-gaa',
    'sv-gil',
    'sv-guw',
    'sv-ha',
    'sv-he',
    'sv-hil',
    'sv-ho',
    'sv-hr',
    'sv-ht',
    'sv-hu',
    'sv-id',
    'sv-ig',
    'sv-ilo',
    'sv-is',
    'sv-iso',
    'sv-kg',
    'sv-kqn',
    'sv-kwy',
    'sv-lg',
    'sv-ln',
    'sv-lu',
    'sv-lua',
    'sv-lue',
    'sv-lus',
    'sv-lv',
    'sv-mfe',
    'sv-mh',
    'sv-mos',
    'sv-mt',
    'sv-niu',
    'sv-nl',
    'sv-nso',
    'sv-ny',
    'sv-pag',
    'sv-pap',
    'sv-pis',
    'sv-pon',
    'sv-rnd',
    'sv-ro',
    'sv-ru',
    'sv-run',
    'sv-rw',
    'sv-sg',
    'sv-sk',
    'sv-sl',
    'sv-sm',
    'sv-sn',
    'sv-sq',
]

from datetime import timedelta
import os
from transformers import MarianMTModel, MarianTokenizer
import argparse

#segments = ['Bonjour cher Christophe', 'Véronique Béchu représente la France dans la lutte internationale contre l’exploitation sexuelle des enfants. C’est dans son service de la brigade des mineurs que la cinéaste Maïwenn avait tourné Polisse (2011), mettant en scène des policiers chargés de lutter contre la pédocriminalité. Elle raconte son expérience d’enquêtrice dans un livre terrible, Derrière l’écran. Combattre l’explosion de la pédocriminalité en ligne (Stock, 300 pages, 20 euros).' ]

#for segment in segments:
#    text = translate(segment)
#    print(text)

def main():

    parser = argparse.ArgumentParser(description="Translate srt files")
    parser.add_argument("files", help="Input file pattern to match",nargs="+")
    parser.add_argument("-l", "--language", help="Specify the input and target language", default="Format: fr-en for French to English", type=str)
    parser.add_argument("-v", "--verbose", help="display errors", action="store_true")

    args = parser.parse_args()

    files = args.files[0]

    global LANG, VERBOSE
    LANG = args.language
    VERBOSE = args.verbose

    if not files:
        print("No input files found matching the pattern.")
        return

    opus_mt_model_name = "Helsinki-NLP/opus-mt-fr-en"
    if LANG:
        if LANG in models:
            opus_mt_model_name = "Helsinki-NLP/opus-mt-" + LANG
        else:
            print(LANG,' is not accepted as an input-target language')
            print('The accepted acronyms are:')
            print(models)
            return
    tokenizer = MarianTokenizer.from_pretrained(opus_mt_model_name)
    opus_mt_model = MarianMTModel.from_pretrained(opus_mt_model_name)
    # print(opus_mt_model_name)

    def translate(str):
        translated = opus_mt_model.generate(**tokenizer(str, return_tensors="pt", padding=True))
        res = [tokenizer.decode(t, skip_special_tokens=True) for t in translated]
        return res[0]
    
    from itertools import groupby
    # "chunk" our input file, delimited by blank lines
    with open(files) as f:
        res = [list(g) for b,g in groupby(f, lambda x: bool(x.strip())) if b]
        for segment in res[0:4]:
            text = translate(segment[2])
            print(segment[0], end="")
            print(segment[1], end="")
            print(text, end="")
            print('\n')

main()
